<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dawens Chatbot Pro+</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
  --bg-dark:#0f172a;
  --bg-light:#f8fafc;
  --text-dark:#e2e8f0;
  --text-light:#1e293b;
  --primary:#6366f1;
  --secondary:#22d3ee;
}
body {
  margin:0;
  font-family:'Poppins',sans-serif;
  background:var(--bg-dark);
  color:var(--text-dark);
  transition:background 0.4s,color 0.4s;
}
header {
  background:var(--primary);
  color:#fff;
  padding:14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 2px 10px rgba(0,0,0,0.4);
}
header h1 {font-size:20px;margin:0;}
#theme-btn,#menu-btn {font-size:22px;cursor:pointer;transition:0.3s;}
#theme-btn:hover,#menu-btn:hover {color:var(--secondary);}
#menu {
  display:none;
  position:absolute;
  top:60px;right:10px;
  background:var(--bg-light);
  color:var(--text-light);
  border-radius:15px;padding:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.3);
}
#menu a {
  display:block;
  padding:8px 15px;
  text-decoration:none;
  color:inherit;
  border-radius:10px;
}
#menu a:hover {background:rgba(99,102,241,0.1);}
#chat-container {display:flex;flex-direction:column;height:calc(100vh - 60px);}
#messages {flex:1;overflow-y:auto;padding:15px;scroll-behavior:smooth;}
.message {display:flex;align-items:flex-start;margin:12px 0;}
.message img {
  width:45px;height:45px;border-radius:50%;margin-right:10px;border:2px solid var(--secondary);
}
.message-content {
  max-width:70%;
  padding:10px 15px;
  border-radius:15px;
  background:#1e293b;
  color:#e2e8f0;
  box-shadow:0 2px 5px rgba(0,0,0,0.3);
}
.user {flex-direction:row-reverse;}
.user .message-content {background:#6366f1;color:#fff;}
.user img {margin-left:10px;margin-right:0;}
#input-container {
  display:flex;
  align-items:center;
  padding:10px;
  background:#111827;
  border-top:1px solid #1e293b;
}
#user-input {
  flex:1;
  padding:10px 15px;
  border-radius:25px;
  border:none;
  outline:none;
  background:#1e293b;
  color:#fff;
}
#input-container button {
  margin-left:8px;
  border:none;
  background:var(--primary);
  color:#fff;
  padding:10px 12px;
  border-radius:50%;
  cursor:pointer;
  transition:0.3s;
}
#input-container button:hover {background:var(--secondary);}
.photo-preview {max-width:200px;border-radius:10px;margin-top:5px;}
.lang-select {
  position:absolute;
  top:70px;left:10px;
  background:#1e293b;
  color:#fff;
  border:none;
  border-radius:10px;
  padding:5px;
}

@keyframes bannerBounce {
  0% { bottom: -150px; opacity: 0; }
  60% { bottom: 40px; opacity: 1; }
  80% { bottom: 25px; }
  100% { bottom: 30px; }
}
</style>
</head>
<body>
<!-- Cookie Banner -->
<div id="cookieBanner" style="
  position:fixed;
  bottom:-150px; /* kÃ²manse anba paj la pou animasyon */
  left:50%;
  transform:translateX(-50%);
  width:90%;
  max-width:500px;
  background:#111827;
  color:#fff;
  padding:15px;
  display:flex;
  flex-direction:column;
  align-items:center;
  z-index:10000;
  box-shadow:0 -2px 10px rgba(0,0,0,0.5);
  font-family:'Poppins',sans-serif;
  border-radius:12px;
  opacity:0;
  transition:all 0.6s ease;
">
  <span style="margin-bottom:12px; text-align:center;">
    Nous utilisons des cookies pour amÃ©liorer votre expÃ©rience.<br>
    ðŸ’³ Profitez de votre <b>Dave Topup</b> maintenant!
  </span>
  <div style="display:flex; justify-content:center; gap:10px; width:100%;">
    <button id="acceptBtn" style="flex:1;padding:10px;background:#6366f1;color:#fff;border:none;border-radius:8px;cursor:pointer;">Accept</button>
    <button id="refuseBtn" style="flex:1;padding:10px;background:#f44336;color:#fff;border:none;border-radius:8px;cursor:pointer;">Refuse</button>
    <button id="learnBtn" style="flex:1;padding:10px;background:#22d3ee;color:#000;border:none;border-radius:8px;cursor:pointer;">Learn More</button>
  </div>
</div>


<header>
  <h1><i class="fa-solid fa-robot"></i> Dawens Chatbot</h1>
  <div>
    <i id="theme-btn" class="fa-solid fa-sun"></i>
    <i id="menu-btn" class="fa-solid fa-bars"></i>
  </div>
</header>

<select id="lang" class="lang-select">
  <option value="fr">ðŸ‡«ðŸ‡· FR</option>
  <option value="en">ðŸ‡ºðŸ‡¸ EN</option>
  <option value="es">ðŸ‡ªðŸ‡¸ ES</option>
  <option value="pt">ðŸ‡§ðŸ‡· PT</option>
  <option value="ht">ðŸ‡­ðŸ‡¹ HT</option>
  <option value="jp">ðŸ‡¯ðŸ‡µ JP</option>
  <option value="kr">ðŸ‡°ðŸ‡· KR</option>
</select>

<!-- menu snippet -->
<div id="menu">
  <a href="bot/library.html">library</a>
  <a id="reportBugLink" href="bot/Report-bug.html">Report bug</a>
  <a href="bot/setting.html">Setting</a>
</div>

<div id="chat-container">
  <div id="messages"></div>

  <div id="input-container">
    <button id="mic-btn"><i class="fa fa-microphone"></i></button>
    <button id="upload-btn"><i class="fa fa-image"></i></button>
    <input type="file" id="upload-photo" accept="image/*" style="display:none;">
    <input type="text" id="user-input" placeholder="Ã‰crivez un message...">
    <button id="send-btn"><i class="fa fa-paper-plane"></i></button>
  </div>
</div>

<script>
const userPhoto='https://files.catbox.moe/j8obz7.png';
const botPhoto='https://files.catbox.moe/o1ai21.png';
const messages=document.getElementById('messages');
const input=document.getElementById('user-input');
const themeBtn=document.getElementById('theme-btn');
let darkMode=localStorage.getItem('theme')!=='light';
let messageCount=0;
let lastTime=localStorage.getItem('lastTime')||0;

// Initial Theme
function applyTheme(){
  if(darkMode){
    document.body.style.background='#0f172a';
    document.body.style.color='#e2e8f0';
    themeBtn.classList.replace('fa-moon','fa-sun');
  } else {
    document.body.style.background='#f8fafc';
    document.body.style.color='#1e293b';
    themeBtn.classList.replace('fa-sun','fa-moon');
  }
}
applyTheme();

// Toggle Theme
themeBtn.onclick=()=>{
  darkMode=!darkMode;
  localStorage.setItem('theme',darkMode?'dark':'light');
  applyTheme();
};

// Menu toggle
const menu=document.getElementById('menu');
document.getElementById('menu-btn').onclick=()=>{
  menu.style.display=menu.style.display==='block'?'none':'block';
};

function cssPathOf(el) {
  if (!el) return '';
  const stack = [];
  while (el.parentElement) {
    let sibCount = 0;
    let sibIndex = 0;
    for (let i = 0; i < el.parentElement.children.length; i++) {
      const sib = el.parentElement.children[i];
      if (sib.nodeName === el.nodeName) {
        if (sib === el) sibIndex = ++sibCount;
        else sibCount++;
      }
    }
    let nodeName = el.nodeName.toLowerCase();
    if (sibCount > 1) nodeName += `:nth-of-type(${sibIndex})`;
    stack.unshift(nodeName);
    el = el.parentElement;
  }
  return stack.length ? stack.join(" > ") : "";
}

document.getElementById('reportBugLink').addEventListener('click', function(ev){
  try {
    const x = ev.clientX;
    const y = ev.clientY;
    const target = ev.target;
    const cssPath = cssPathOf(target);
    const clickInfo = {
      timestamp: new Date().toISOString(),
      clientX: x,
      clientY: y,
      selector: cssPath,
      pageUrl: location.href,
      viewportWidth: window.innerWidth,
      viewportHeight: window.innerHeight
    };
    sessionStorage.setItem('reportBugClickInfo', JSON.stringify(clickInfo));
    // allow normal navigation to proceed
  } catch(e) {
    console.error('Could not store click info', e);
  }
});

// Add message
function addMessage(text,sender='user',photo){
  const msg=document.createElement('div');
  msg.classList.add('message',sender);
  const img=document.createElement('img');
  img.src=photo||(sender==='user'?userPhoto:botPhoto);
  const content=document.createElement('div');
  content.classList.add('message-content');
  content.innerHTML=text;
  msg.appendChild(img);
  msg.appendChild(content);
  messages.appendChild(msg);
  messages.scrollTop=messages.scrollHeight;
}

// Upload photo
document.getElementById('upload-photo').onchange = async e => {
  const file = e.target.files[0];
  if (!file) return;

  const userMsg = prompt("Ajoute yon mesaj pou foto sa a (oswa kite vid pou seulement foto):");

  const reader = new FileReader();
  reader.onload = x => {
    const imgData = x.target.result;

    let content = `<img src="${imgData}" class="photo-preview">`;
    if (userMsg && userMsg.trim() !== '') {
      content += `<br>${userMsg}`;
    }
    addMessage(content, 'user');

    // Save photo + optional message in library
    saveToLibrary(imgData, userMsg);

    // Voye tÃ¨ks la nan Gemini si gen
    if (userMsg && userMsg.trim() !== '') {
      sendToGemini(userMsg);
    }
  };
  reader.readAsDataURL(file);
  e.target.value = '';
};

// Function to save image + message in localStorage library
function saveToLibrary(imageData, message='') {
  const library = JSON.parse(localStorage.getItem('chatLibrary')||'[]');
  library.push({image: imageData, message, date: new Date().toISOString()});
  localStorage.setItem('chatLibrary', JSON.stringify(library));
}

// Voice recognition
let recognition;
if('webkitSpeechRecognition' in window){
  recognition=new webkitSpeechRecognition();
  recognition.lang='fr-FR';
  recognition.onresult=e=>{
    const transcript=e.results[0][0].transcript;
    addMessage(transcript,'user');
    sendToGemini(transcript);
  };
}
document.getElementById('mic-btn').onclick=()=>{
  if(recognition) recognition.start();
};

  // Lis mo kle ilegal / ofansif
const blockedWords = [
  "hack", "pirate", "drugs", "kill", "violence", "terror", "illegal",
  "sex", "nsfw", "bomb", "crime", "attack"
];

// Fonksyon pou verifye tÃ¨ks
function isTextAllowed(text) {
  const lower = text.toLowerCase();
  return !blockedWords.some(word => lower.includes(word));
}

// Modify bouton send
document.getElementById('send-btn').onclick = () => {
  const text = input.value.trim();
  if (!text) return;

  if(!isTextAllowed(text)) {
    addMessage("ðŸš« Kesyon sa a entÃ¨di. Eseye poze yon lÃ²t kesyon.", 'bot', botPhoto);
    input.value = '';
    return;
  }

  addMessage(text, 'user');
  sendToGemini(text);
  input.value = '';
};

// Modify sendToGemini pou verifye mesaj ki soti nan foto / vwa
async function sendToGemini(prompt){
  if(!isTextAllowed(prompt)){
    addMessage("ðŸš« Kesyon sa a entÃ¨di. Eseye poze yon lÃ²t kesyon.", 'bot', botPhoto);
    return;
  }

  // â€¦ rÃ¨s kÃ²d Gemini la rete menm jan
}
// Gemini Call dirÃ¨k
async function sendToGemini(prompt){
  if(messageCount>=50){
    const now=Date.now();
    if(now-lastTime<86400000){
      addMessage("â³ Limite 50 messages / 24h atteinte. RÃ©essayez plus tard.",'bot',botPhoto);
      return;
    } else {messageCount=0;}
  }
  messageCount++;
  localStorage.setItem('lastTime',Date.now());

  const lang=document.getElementById('lang').value;
  addMessage('<i>Le bot rÃ©flÃ©chit...</i>','bot',botPhoto);

  // Mete API key ou la a
  const GEMINI_API_KEY = "AIzaSyB7URXCSpZtdCdKCjBGkvV27nLURDDn1FM"; // <-- mete kle w isit

  try {
    const res = await fetch("https://api.gemini.com/v1/complete", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${GEMINI_API_KEY}`
      },
      body: JSON.stringify({
        prompt: prompt,
        max_tokens: 150
      })
    });

    const data = await res.json();
    const reply = data.reply || data.text || "Erreur.";
    addMessage(reply,'bot',botPhoto);
    speakReply(reply,lang);

    if(prompt.toLowerCase().includes("kiyes")||prompt.toLowerCase().includes("crÃ©Ã©")||prompt.toLowerCase().includes("creator")){
      addMessage("ðŸ‘‘ Bot crÃ©Ã© par <b>Dawens</b> ðŸ”¥",'bot',botPhoto);
    }
  } catch(e) {
    console.error(e);
    addMessage("âŒ Erreur lors de l'appel API Gemini.",'bot',botPhoto);
  }
}

// Bot voice reply
function speakReply(text,lang){
  if('speechSynthesis' in window){
    const speech=new SpeechSynthesisUtterance(text);
    const map={
      fr:'fr-FR',en:'en-US',es:'es-ES',pt:'pt-PT',
      ht:'ht-HT',jp:'ja-JP',kr:'ko-KR'
    };
    speech.lang=map[lang]||'fr-FR';
    window.speechSynthesis.speak(speech);
  }
}

// Send button
document.getElementById('send-btn').onclick=()=>{
  const text=input.value.trim();
  if(text){
    addMessage(text,'user');
    sendToGemini(text);
    input.value='';
  }
};

// Auto select lang from browser
window.onload=()=>{
  const browserLang=navigator.language.slice(0,2);
  const langSelect=document.getElementById('lang');
  if([...langSelect.options].some(opt=>opt.value===browserLang)){
    langSelect.value=browserLang;
  }
  addMessage("ðŸ‘‹ Bienvenue sur <b>Dawens Chatbot Pro+</b> â€” comment puis-je vous aider aujourdâ€™hui ?",'bot',botPhoto);
};

const banner = document.getElementById('cookieBanner');
const consent = localStorage.getItem('cookiesConsent');

// Fonksyon pou montre banner ak animasyon
function showBanner() {
  banner.style.bottom = '30px'; // retabli pozisyon
  banner.style.opacity = '1';
  banner.style.animation = 'bannerBounce 0.5s ease forwards';
}

// Si itilizatÃ¨ poko fÃ¨ chwa
if (!consent) {
  // Montre li premye fwa
  setTimeout(showBanner, 0);

  // ReparÃ¨t chak 5s si toujou pa gen chwa
  setInterval(() => {
    const currentConsent = localStorage.getItem('cookiesConsent');
    if (!currentConsent) showBanner();
  }, 500); // 80000 ms = 80 segonn
}

// Bouton Accept
document.getElementById('acceptBtn').addEventListener('click', () => {
  localStorage.setItem('cookiesConsent','accepted');
  banner.style.opacity = '0';
  banner.style.bottom = '-150px';
});

// Bouton Refuse
document.getElementById('refuseBtn').addEventListener('click', () => {
  localStorage.setItem('cookiesConsent','refused');
  banner.style.opacity = '0';
  banner.style.bottom = '-150px';
});

// Bouton Learn More
document.getElementById('learnBtn').addEventListener('click', () => {
  alert('Pour en savoir plus sur nos cookies, visitez: www.example.com/cookies');
});
</script>
</body>
</html>
