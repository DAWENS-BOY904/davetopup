<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dawens Chatbot Pro+</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
  --bg-dark:#0f172a;
  --bg-light:#f8fafc;
  --text-dark:#e2e8f0;
  --text-light:#1e293b;
  --primary:#6366f1;
  --secondary:#22d3ee;
}
body {
  margin:0;
  font-family:'Poppins',sans-serif;
  background:var(--bg-dark);
  color:var(--text-dark);
  transition:background 0.4s,color 0.4s;
}
header {
  background:var(--primary);
  color:#fff;
  padding:14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 2px 10px rgba(0,0,0,0.4);
}
header h1 {font-size:20px;margin:0;}
#theme-btn,#menu-btn {font-size:22px;cursor:pointer;transition:0.3s;}
#theme-btn:hover,#menu-btn:hover {color:var(--secondary);}
#menu {
  display:none;
  position:absolute;
  top:60px;right:10px;
  background:var(--bg-light);
  color:var(--text-light);
  border-radius:15px;padding:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.3);
  z-index:100;
}
#menu a {
  display:block;
  padding:8px 15px;
  text-decoration:none;
  color:inherit;
  border-radius:10px;
  cursor:pointer;
}
#menu a:hover {background:rgba(99,102,241,0.1);}
#chat-container {display:flex;flex-direction:column;height:calc(100vh - 60px);}
#messages {flex:1;overflow-y:auto;padding:15px;scroll-behavior:smooth;}
.message {display:flex;align-items:flex-start;margin:12px 0;}
.message img {
  width:45px;height:45px;border-radius:50%;margin-right:10px;border:2px solid var(--secondary);
}
.message-content {
  max-width:70%;
  padding:10px 15px;
  border-radius:15px;
  background:#1e293b;
  color:#e2e8f0;
  box-shadow:0 2px 5px rgba(0,0,0,0.3);
}
.user {flex-direction:row-reverse;}
.user .message-content {background:#6366f1;color:#fff;}
.user img {margin-left:10px;margin-right:0;}
#input-container {
  display:flex;
  align-items:center;
  padding:10px;
  background:#111827;
  border-top:1px solid #1e293b;
}
#user-input {
  flex:1;
  padding:10px 15px;
  border-radius:25px;
  border:none;
  outline:none;
  background:#1e293b;
  color:#fff;
}
#input-container button {
  margin-left:8px;
  border:none;
  background:var(--primary);
  color:#fff;
  padding:10px 12px;
  border-radius:50%;
  cursor:pointer;
  transition:0.3s;
}
#input-container button:hover {background:var(--secondary);}
.photo-preview {max-width:200px;border-radius:10px;margin-top:5px;}
.lang-select {
  position:absolute;
  top:70px;left:10px;
  background:#1e293b;
  color:#fff;
  border:none;
  border-radius:10px;
  padding:5px;
}

/* API Settings Modal */
.modal {
  display:none;
  position:fixed;
  top:0;left:0;
  width:100%;height:100%;
  background:rgba(0,0,0,0.7);
  z-index:1000;
  justify-content:center;
  align-items:center;
}
.modal-content {
  background:var(--bg-dark);
  padding:30px;
  border-radius:15px;
  width:90%;
  max-width:500px;
  box-shadow:0 4px 20px rgba(0,0,0,0.5);
}
.modal-content h2 {
  margin-top:0;
  color:var(--primary);
  font-size:24px;
}
.modal-content label {
  display:block;
  margin-top:15px;
  margin-bottom:5px;
  color:var(--text-dark);
  font-weight:500;
}
.modal-content input, .modal-content select {
  width:100%;
  padding:12px;
  border:2px solid #1e293b;
  border-radius:10px;
  background:#1e293b;
  color:#fff;
  font-size:14px;
  box-sizing:border-box;
}
.modal-content input:focus {
  outline:none;
  border-color:var(--primary);
}
.modal-actions {
  display:flex;
  gap:10px;
  margin-top:20px;
  justify-content:flex-end;
}
.modal-actions button {
  padding:10px 20px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-size:14px;
  font-weight:600;
  transition:0.3s;
}
.save-btn {
  background:var(--primary);
  color:#fff;
}
.save-btn:hover {
  background:var(--secondary);
  color:#000;
}
.cancel-btn {
  background:#334155;
  color:#fff;
}
.cancel-btn:hover {
  background:#475569;
}
.api-status {
  margin-top:10px;
  padding:10px;
  border-radius:8px;
  font-size:13px;
}
.api-status.success {
  background:#10b981;
  color:#fff;
}
.api-status.error {
  background:#ef4444;
  color:#fff;
}
.api-info {
  background:#1e293b;
  padding:10px;
  border-radius:8px;
  margin-top:10px;
  font-size:12px;
  color:#94a3b8;
}

@keyframes bannerBounce {
  0% { bottom: -150px; opacity: 0; }
  60% { bottom: 40px; opacity: 1; }
  80% { bottom: 25px; }
  100% { bottom: 30px; }
}
</style>
</head>
<body>
<!-- Cookie Banner -->
<div id="cookieBanner" style="
  position:fixed;
  bottom:-150px;
  left:50%;
  transform:translateX(-50%);
  width:90%;
  max-width:500px;
  background:#111827;
  color:#fff;
  padding:15px;
  display:flex;
  flex-direction:column;
  align-items:center;
  z-index:10000;
  box-shadow:0 -2px 10px rgba(0,0,0,0.5);
  font-family:'Poppins',sans-serif;
  border-radius:12px;
  opacity:0;
  transition:all 0.6s ease;
">
  <span style="margin-bottom:12px; text-align:center;">
    Nous utilisons des cookies pour amÃ©liorer votre expÃ©rience.<br>
    ðŸ’³ Profitez de votre <b>Dave Topup</b> maintenant!
  </span>
  <div style="display:flex; justify-content:center; gap:10px; width:100%;">
    <button id="acceptBtn" style="flex:1;padding:10px;background:#6366f1;color:#fff;border:none;border-radius:8px;cursor:pointer;">Accept</button>
    <button id="refuseBtn" style="flex:1;padding:10px;background:#f44336;color:#fff;border:none;border-radius:8px;cursor:pointer;">Refuse</button>
    <button id="learnBtn" style="flex:1;padding:10px;background:#22d3ee;color:#000;border:none;border-radius:8px;cursor:pointer;">Learn More</button>
  </div>
</div>

<!-- API Settings Modal -->
<div id="apiModal" class="modal">
  <div class="modal-content">
    <h2><i class="fa fa-key"></i> API Settings</h2>
    
    <label>Select AI Provider:</label>
    <select id="aiProvider">
      <option value="anthropic">Anthropic (Claude)</option>
      <option value="openai">OpenAI (GPT)</option>
      <option value="gemini">Google (Gemini)</option>
    </select>
    
    <label>API Key:</label>
    <input type="password" id="apiKeyInput" placeholder="Enter your API key...">
    
    <div class="api-info">
      <strong>How to get API keys:</strong><br>
      â€¢ <b>Anthropic:</b> console.anthropic.com<br>
      â€¢ <b>OpenAI:</b> platform.openai.com<br>
      â€¢ <b>Gemini:</b> makersuite.google.com
    </div>
    
    <div id="apiStatus"></div>
    
    <div class="modal-actions">
      <button class="cancel-btn" onclick="closeApiModal()">Cancel</button>
      <button class="save-btn" onclick="saveApiSettings()">Save</button>
    </div>
  </div>
</div>

<header>
  <h1><i class="fa-solid fa-robot"></i> Dawens Chatbot</h1>
  <div>
    <i id="theme-btn" class="fa-solid fa-sun"></i>
    <i id="menu-btn" class="fa-solid fa-bars"></i>
  </div>
</header>

<select id="lang" class="lang-select">
  <option value="fr">ðŸ‡«ðŸ‡· FR</option>
  <option value="en">ðŸ‡ºðŸ‡¸ EN</option>
  <option value="es">ðŸ‡ªðŸ‡¸ ES</option>
  <option value="pt">ðŸ‡§ðŸ‡· PT</option>
  <option value="ht">ðŸ‡­ðŸ‡¹ HT</option>
  <option value="jp">ðŸ‡¯ðŸ‡µ JP</option>
  <option value="kr">ðŸ‡°ðŸ‡· KR</option>
</select>

<div id="menu">
  <a onclick="openApiModal()"><i class="fa fa-key"></i> API Settings</a>
  <a href="bot/library.html"><i class="fa fa-book"></i> Library</a>
  <a href="Report-bug.html"><i class="fa fa-bug"></i> Report bug</a>
  <a href="bot/setting.html"><i class="fa fa-gear"></i> Settings</a>
</div>

<div id="chat-container">
  <div id="messages"></div>

  <div id="input-container">
    <button id="mic-btn"><i class="fa fa-microphone"></i></button>
    <button id="upload-btn" onclick="document.getElementById('upload-photo').click()"><i class="fa fa-image"></i></button>
    <input type="file" id="upload-photo" accept="image/*" style="display:none;">
    <input type="text" id="user-input" placeholder="Ã‰crivez un message...">
    <button id="send-btn"><i class="fa fa-paper-plane"></i></button>
  </div>
</div>

<script>
const userPhoto='https://files.catbox.moe/j8obz7.png';
const botPhoto='https://files.catbox.moe/o1ai21.png';
const messages=document.getElementById('messages');
const input=document.getElementById('user-input');
const themeBtn=document.getElementById('theme-btn');
let darkMode=localStorage.getItem('theme')!=='light';
let messageCount=0;
let lastTime=parseInt(localStorage.getItem('lastTime')||'0',10);

// API Settings
let apiProvider = localStorage.getItem('apiProvider') || 'anthropic';
let apiKey = localStorage.getItem('apiKey') || '';

// Modal Functions
function openApiModal() {
  document.getElementById('apiModal').style.display = 'flex';
  document.getElementById('aiProvider').value = apiProvider;
  document.getElementById('apiKeyInput').value = apiKey;
  document.getElementById('menu').style.display = 'none';
}

function closeApiModal() {
  document.getElementById('apiModal').style.display = 'none';
}

function saveApiSettings() {
  const provider = document.getElementById('aiProvider').value;
  const key = document.getElementById('apiKeyInput').value.trim();
  const statusDiv = document.getElementById('apiStatus');
  
  if (!key) {
    statusDiv.className = 'api-status error';
    statusDiv.textContent = 'âŒ Please enter an API key';
    return;
  }
  
  apiProvider = provider;
  apiKey = key;
  localStorage.setItem('apiProvider', provider);
  localStorage.setItem('apiKey', key);
  
  statusDiv.className = 'api-status success';
  statusDiv.textContent = 'âœ… API settings saved successfully!';
  
  setTimeout(() => {
    closeApiModal();
    statusDiv.textContent = '';
  }, 2000);
}

// Close modal on outside click
window.onclick = function(event) {
  const modal = document.getElementById('apiModal');
  if (event.target === modal) {
    closeApiModal();
  }
}

// Initial Theme
function applyTheme(){
  if(darkMode){
    document.body.style.background='#0f172a';
    document.body.style.color='#e2e8f0';
    themeBtn.classList.replace('fa-moon','fa-sun');
  } else {
    document.body.style.background='#f8fafc';
    document.body.style.color='#1e293b';
    themeBtn.classList.replace('fa-sun','fa-moon');
  }
}
applyTheme();

// Toggle Theme
themeBtn.onclick=()=>{
  darkMode=!darkMode;
  localStorage.setItem('theme',darkMode?'dark':'light');
  applyTheme();
};

// Menu toggle
const menu=document.getElementById('menu');
document.getElementById('menu-btn').onclick=()=>{
  menu.style.display=menu.style.display==='block'?'none':'block';
};

// Add message
function addMessage(text,sender='user',photo){
  const msg=document.createElement('div');
  msg.classList.add('message',sender);
  const img=document.createElement('img');
  img.src=photo||(sender==='user'?userPhoto:botPhoto);
  const content=document.createElement('div');
  content.classList.add('message-content');
  content.innerHTML=text;
  msg.appendChild(img);
  msg.appendChild(content);
  messages.appendChild(msg);
  messages.scrollTop=messages.scrollHeight;
}

// Send message with API
async function sendMessage(prompt, imageData = null){
  if(!apiKey){
    addMessage("âš ï¸ Please configure your API key in Settings first!",'bot',botPhoto);
    setTimeout(() => openApiModal(), 1000);
    return;
  }
  
  if(messageCount>=50){
    const now=Date.now();
    if(now-lastTime<86400000){
      addMessage("â³ Limite 50 messages / 24h atteinte. RÃ©essayez plus tard.",'bot',botPhoto);
      return;
    } else {messageCount=0;}
  }
  messageCount++;
  localStorage.setItem('lastTime',Date.now());
  
  const lang=document.getElementById('lang').value;
  addMessage('<i class="fa fa-spinner fa-spin"></i> Le bot rÃ©flÃ©chit...','bot',botPhoto);

  try {
    let reply = '';
    
    if(apiProvider === 'anthropic'){
      reply = await callAnthropicAPI(prompt, imageData);
    } else if(apiProvider === 'openai'){
      reply = await callOpenAIAPI(prompt, imageData);
    } else if(apiProvider === 'gemini'){
      reply = await callGeminiAPI(prompt, imageData);
    }
    
    // Remove loading message
    messages.removeChild(messages.lastChild);
    addMessage(reply,'bot',botPhoto);
    speakReply(reply,lang);
    
  } catch(e){
    messages.removeChild(messages.lastChild);
    console.error("API error:",e);
    addMessage("âŒ Error: " + e.message,'bot',botPhoto);
  }
}

// Anthropic API
async function callAnthropicAPI(prompt, imageData){
  const content = [];
  
  if(imageData){
    const base64Data = imageData.split(',')[1];
    const mediaType = imageData.split(';')[0].split(':')[1];
    content.push({
      type: "image",
      source: {type: "base64", media_type: mediaType, data: base64Data}
    });
  }
  
  content.push({type: "text", text: prompt});
  
  const res = await fetch("https://api.anthropic.com/v1/messages", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-api-key": apiKey,
      "anthropic-version": "2023-06-01"
    },
    body: JSON.stringify({
      model: "claude-sonnet-4-20250514",
      max_tokens: 1000,
      messages: [{role: "user", content: content}]
    })
  });
  
  if(!res.ok){
    const error = await res.json();
    throw new Error(error.error?.message || 'API request failed');
  }
  
  const data = await res.json();
  return data.content[0].text;
}

// OpenAI API
async function callOpenAIAPI(prompt, imageData){
  const messages = [{role: "system", content: "You are a helpful AI assistant"}];
  
  if(imageData){
    messages.push({
      role: "user",
      content: [
        {type: "text", text: prompt},
        {type: "image_url", image_url: {url: imageData}}
      ]
    });
  } else {
    messages.push({role: "user", content: prompt});
  }
  
  const res = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${apiKey}`
    },
    body: JSON.stringify({
      model: imageData ? "gpt-4-vision-preview" : "gpt-4",
      messages: messages,
      max_tokens: 1000
    })
  });
  
  if(!res.ok){
    const error = await res.json();
    throw new Error(error.error?.message || 'API request failed');
  }
  
  const data = await res.json();
  return data.choices[0].message.content;
}

// Gemini API
async function callGeminiAPI(prompt, imageData){
  const parts = [{text: prompt}];
  
  if(imageData){
    const base64Data = imageData.split(',')[1];
    const mimeType = imageData.split(';')[0].split(':')[1];
    parts.push({
      inline_data: {
        mime_type: mimeType,
        data: base64Data
      }
    });
  }
  
  const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro-vision:generateContent?key=${apiKey}`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({contents: [{parts: parts}]})
  });
  
  if(!res.ok){
    const error = await res.json();
    throw new Error(error.error?.message || 'API request failed');
  }
  
  const data = await res.json();
  return data.candidates[0].content.parts[0].text;
}

// Bot voice reply
function speakReply(text,lang){
  if('speechSynthesis' in window){
    const speech=new SpeechSynthesisUtterance(text);
    const map={fr:'fr-FR',en:'en-US',es:'es-ES',pt:'pt-PT',ht:'ht-HT',jp:'ja-JP',kr:'ko-KR'};
    speech.lang=map[lang]||'fr-FR';
    window.speechSynthesis.speak(speech);
  }
}

// Send button
document.getElementById('send-btn').onclick=()=>{
  const text=input.value.trim();
  if(text){
    addMessage(text,'user');
    sendMessage(text);
    input.value='';
  }
};

// Enter key
input.addEventListener('keypress', e => {
  if(e.key === 'Enter'){
    document.getElementById('send-btn').click();
  }
});

// Voice recognition
let recognition;
if('webkitSpeechRecognition' in window){
  recognition=new webkitSpeechRecognition();
  recognition.lang='fr-FR';
  recognition.onresult=e=>{
    const transcript=e.results[0][0].transcript;
    addMessage(transcript,'user');
    sendMessage(transcript);
  };
}
document.getElementById('mic-btn').onclick=()=>{
  if(recognition) recognition.start();
};

// Upload photo
document.getElementById('upload-photo').onchange = async e => {
  const file = e.target.files[0];
  if (!file) return;

  const userMsg = prompt("Add a message for this photo (or leave empty):");
  const reader = new FileReader();
  reader.onload = x => {
    const imgData = x.target.result;
    let content = `<img src="${imgData}" class="photo-preview">`;
    if (userMsg && userMsg.trim() !== '') content += `<br>${userMsg}`;
    addMessage(content,'user');
    saveToLibrary(imgData,userMsg);
    sendMessage(userMsg || "What's in this image?", imgData);
  };
  reader.readAsDataURL(file);
  e.target.value = '';
};

// Save to localStorage
function saveToLibrary(imageData,message=''){
  const library=JSON.parse(localStorage.getItem('chatLibrary')||'[]');
  library.push({image:imageData,message,date:new Date().toISOString()});
  localStorage.setItem('chatLibrary',JSON.stringify(library));
}

// Auto select lang from browser
window.addEventListener('load',()=>{
  const browserLang=navigator.language.slice(0,2);
  const langSelect=document.getElementById('lang');
  if([...langSelect.options].some(opt=>opt.value===browserLang)) langSelect.value=browserLang;
  addMessage("ðŸ‘‹ Bienvenue sur <b>Dawens Chatbot Pro+</b> â€” comment puis-je vous aider aujourd'hui ?",'bot',botPhoto);
  
  // Show API settings if not configured
  if(!apiKey){
    setTimeout(() => {
      addMessage("âš™ï¸ Please configure your API key to start chatting!",'bot',botPhoto);
    }, 1000);
  }
});

// Cookie banner (keep original functionality)
document.getElementById('acceptBtn')?.addEventListener('click', () => {
  document.getElementById('cookieBanner').style.bottom = '-150px';
});
document.getElementById('refuseBtn')?.addEventListener('click', () => {
  document.getElementById('cookieBanner').style.bottom = '-150px';
});
</script>
</body>
</html>
